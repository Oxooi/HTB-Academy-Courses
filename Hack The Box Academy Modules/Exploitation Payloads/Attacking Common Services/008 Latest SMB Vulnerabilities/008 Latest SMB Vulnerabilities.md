
<h1>Latest SMB Vulnerabilities</h1>
<hr/>
<p>One recent significant vulnerability that affected the SMB protocol was called <a href="https://arista.my.site.com/AristaCommunity/s/article/SMBGhost-Wormable-Vulnerability-Analysis-CVE-2020-0796">SMBGhost</a> with the <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-0796">CVE-2020-0796</a>. The vulnerability consisted of a compression mechanism of the version SMB v3.1.1 which made Windows 10 versions 1903 and 1909 vulnerable to attack by an unauthenticated attacker. The vulnerability allowed the attacker to gain remote code execution (<code>RCE</code>) and full access to the remote target system.</p>
<p>We will not discuss the vulnerability in detail in this section, as a very in-depth explanation requires some reverse engineering experience and advanced knowledge of CPU, kernel, and exploit development. Instead, we will only focus on the attack concept because even with more complicated exploits and vulnerabilities, the concept remains the same.</p>
<hr/>
<h2>The Concept of the Attack</h2>
<p>In simple terms, this is an <a href="https://en.wikipedia.org/wiki/Integer_overflow">integer overflow</a> vulnerability in a function of an SMB driver that allows system commands to be overwritten while accessing memory. An integer overflow results from a CPU attempting to generate a number that is greater than the value required for the allocated memory space. Arithmetic operations can always return unexpected values, resulting in an error. An example of an integer overflow can occur when a programmer does not allow a negative number to occur. In this case, an integer overflow occurs when a variable performs an operation that results in a negative number, and the variable is returned as a positive integer. This vulnerability occurred because, at the time, the function lacked bounds checks to handle the size of the data sent in the process of SMB session negotiation.</p>
<p>To learn more about buffer overflow techniques and vulnerabilities, check out the <a href="https://academy.hackthebox.com/course/preview/stack-based-buffer-overflows-on-linux-x86">Stack-Based Buffer Overflows on Linux x86</a>, and <a href="https://academy.hackthebox.com/course/preview/stack-based-buffer-overflows-on-windows-x86">Stack-Based Buffer Overflows on Windows x86</a> module. These go into detail on the basics of how the buffer can be overwritten and handled by the attacker.</p>
<h4>The Concept of Attacks</h4>
<p><img alt="" src="https://academy.hackthebox.com/storage/modules/116/attack_concept2.png"/></p>
<p>The vulnerability occurs while processing a malformed compressed message after the <code>Negotiate Protocol Responses</code>. If the SMB server allows requests (over TCP/445), compression is generally supported, where the server and client set the terms of communication before the client sends any more data. Suppose the data transmitted exceeds the integer variable limits due to the excessive amount of data. In that case, these parts are written into the buffer, which leads to the overwriting of the subsequent CPU instructions and interrupts the process's normal or planned execution. These data sets can be structured so that the overwritten instructions are replaced with our own ones, and thus we force the CPU (and hence also the process) to perform other tasks and instructions.</p>
<h4>Initiation of the Attack</h4>
<table>
<thead>
<tr>
<th><strong>Step</strong></th>
<th><strong>SMBGhost</strong></th>
<th><strong>Concept of Attacks - Category</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1.</code></td>
<td>The client sends a request manipulated by the attacker to the SMB server.</td>
<td><code>Source</code></td>
</tr>
<tr>
<td><code>2.</code></td>
<td>The sent compressed packets are processed according to the negotiated protocol responses.</td>
<td><code>Process</code></td>
</tr>
<tr>
<td><code>3.</code></td>
<td>This process is performed with the system's privileges or at least with the privileges of an administrator.</td>
<td><code>Privileges</code></td>
</tr>
<tr>
<td><code>4.</code></td>
<td>The local process is used as the destination, which should process these compressed packets.</td>
<td><code>Destination</code></td>
</tr>
</tbody>
</table>
<p>This is when the cycle starts all over again, but this time to gain remote access to the target system.</p>
<h4>Trigger Remote Code Execution</h4>
<table>
<thead>
<tr>
<th><strong>Step</strong></th>
<th><strong>SMBGhost</strong></th>
<th><strong>Concept of Attacks - Category</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>5.</code></td>
<td>The sources used in the second cycle are from the previous process.</td>
<td><code>Source</code></td>
</tr>
<tr>
<td><code>6.</code></td>
<td>In this process, the integer overflow occurs by replacing the overwritten buffer with the attacker's instructions and forcing the CPU to execute those instructions.</td>
<td><code>Process</code></td>
</tr>
<tr>
<td><code>7.</code></td>
<td>The same privileges of the SMB server are used.</td>
<td><code>Privileges</code></td>
</tr>
<tr>
<td><code>8.</code></td>
<td>The remote attacker system is used as the destination, in this case, granting access to the local system.</td>
<td><code>Destination</code></td>
</tr>
</tbody>
</table>
<p>However, despite the vulnerability's complexity due to the buffer's manipulation, which we can see in the <a href="https://www.exploit-db.com/exploits/48537">PoC</a>, the concept of the attack nevertheless applies here.</p>
