
<h1>FTP</h1>
<hr/>
<p>The <code>File Transfer Protocol</code> (<code>FTP</code>) is one of the oldest protocols on the Internet. The FTP runs within the application layer of the TCP/IP protocol stack. Thus, it is on the same layer as <code>HTTP</code> or <code>POP</code>. These protocols also work with the support of browsers or email clients to perform their services. There are also special FTP programs for the File Transfer Protocol.</p>
<p>Let us imagine that we want to upload local files to a server and download other files using the <a href="https://datatracker.ietf.org/doc/html/rfc959">FTP</a> protocol. In an FTP connection, two channels are opened. First, the client and server establish a control channel through <code>TCP port 21</code>. The client sends commands to the server, and the server returns status codes. Then both communication participants can establish the data channel via <code>TCP port 20</code>. This channel is used exclusively for data transmission, and the protocol watches for errors during this process. If a connection is broken off during transmission, the transport can be resumed after re-established contact.</p>
<p>A distinction is made between <code>active</code> and <code>passive</code> FTP. In the active variant, the client establishes the connection as described via TCP port 21 and thus informs the server via which client-side port the server can transmit its responses. However, if a firewall protects the client, the server cannot reply because all external connections are blocked. For this purpose, the <code>passive mode</code> has been developed. Here, the server announces a port through which the client can establish the data channel. Since the client initiates the connection in this method, the firewall does not block the transfer.</p>
<p>The FTP knows different <a href="https://web.archive.org/web/20230326204635/https://www.smartfile.com/blog/the-ultimate-ftp-commands-list/">commands</a> and status codes. Not all of these commands are consistently implemented on the server. For example, the client-side instructs the server-side to upload or download files, organize directories or delete files. The server responds in each case with a status code that indicates whether the command was successfully implemented. A list of possible status codes can be found <a href="https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes">here</a>.</p>
<p>Usually, we need credentials to use FTP on a server. We also need to know that FTP is a <code>clear-text</code> protocol that can sometimes be sniffed if conditions on the network are right. However, there is also the possibility that a server offers <code>anonymous FTP</code>. The server operator then allows any user to upload or download files via FTP without using a password. Since there are security risks associated with such a public FTP server, the options for users are usually limited.</p>
<hr/>
<h2>TFTP</h2>
<p><code>Trivial File Transfer Protocol</code> (<code>TFTP</code>) is simpler than FTP and performs file transfers between client and server processes. However, it <code>does not</code> provide user authentication and other valuable features supported by FTP. In addition, while FTP uses TCP, TFTP uses <code>UDP</code>, making it an unreliable protocol and causing it to use UDP-assisted application layer recovery.</p>
<p>This is reflected, for example, in the fact that TFTP, unlike FTP, does not require the user's authentication. It does not support protected login via passwords and sets limits on access based solely on the read and write permissions of a file in the operating system. Practically, this leads to TFTP operating exclusively in directories and with files that have been shared with all users and can be read and written globally. Because of the lack of security, TFTP, unlike FTP, may only be used in local and protected networks.</p>
<p>Let us take a look at a few commands of <code>TFTP</code>:</p>
<table>
<thead>
<tr>
<th><strong>Commands</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>connect</code></td>
<td>Sets the remote host, and optionally the port, for file transfers.</td>
</tr>
<tr>
<td><code>get</code></td>
<td>Transfers a file or set of files from the remote host to the local host.</td>
</tr>
<tr>
<td><code>put</code></td>
<td>Transfers a file or set of files from the local host onto the remote host.</td>
</tr>
<tr>
<td><code>quit</code></td>
<td>Exits tftp.</td>
</tr>
<tr>
<td><code>status</code></td>
<td>Shows the current status of tftp, including the current transfer mode (ascii or binary), connection status, time-out value, and so on.</td>
</tr>
<tr>
<td><code>verbose</code></td>
<td>Turns verbose mode, which displays additional information during file transfer, on or off.</td>
</tr>
</tbody>
</table>
<p>Unlike the FTP client, <code>TFTP</code> does not have directory listing functionality.</p>
<hr/>
<h2>Default Configuration</h2>
<p>One of the most used FTP servers on Linux-based distributions is <a href="https://security.appspot.com/vsftpd.html">vsFTPd</a>. The default configuration of vsFTPd can be found in <code>/etc/vsftpd.conf</code>, and some settings are already predefined by default. It is highly recommended to install the vsFTPd server on a VM and have a closer look at this configuration.</p>
<h4>Install vsFTPd</h4>
<pre><code class="language-shell-session">[!bash!]$ sudo apt install vsftpd 
</code></pre>
<p>The vsFTPd server is only one of a few FTP servers available to us. There are many different alternatives to it, which also bring, among other things, many more functions and configuration options with them. We will use the vsFTPd server because it is an excellent way to show the configuration possibilities of an FTP server in a simple and easy-to-understand way without going into the details of the man pages. If we look at the configuration file of vsFTPd, we will see many options and settings that are either commented or commented out. However, the configuration file does not contain all possible settings that can be made. The existing and missing ones can be found on the <a href="http://vsftpd.beasts.org/vsftpd_conf.html">man page</a>.</p>
<h4>vsFTPd Config File</h4>
<pre><code class="language-shell-session">[!bash!]$ cat /etc/vsftpd.conf | grep -v "#"
</code></pre>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>listen=NO</code></td>
<td>Run from inetd or as a standalone daemon?</td>
</tr>
<tr>
<td><code>listen_ipv6=YES</code></td>
<td>Listen on IPv6 ?</td>
</tr>
<tr>
<td><code>anonymous_enable=NO</code></td>
<td>Enable Anonymous access?</td>
</tr>
<tr>
<td><code>local_enable=YES</code></td>
<td>Allow local users to login?</td>
</tr>
<tr>
<td><code>dirmessage_enable=YES</code></td>
<td>Display active directory messages when users go into certain directories?</td>
</tr>
<tr>
<td><code>use_localtime=YES</code></td>
<td>Use local time?</td>
</tr>
<tr>
<td><code>xferlog_enable=YES</code></td>
<td>Activate logging of uploads/downloads?</td>
</tr>
<tr>
<td><code>connect_from_port_20=YES</code></td>
<td>Connect from port 20?</td>
</tr>
<tr>
<td><code>secure_chroot_dir=/var/run/vsftpd/empty</code></td>
<td>Name of an empty directory</td>
</tr>
<tr>
<td><code>pam_service_name=vsftpd</code></td>
<td>This string is the name of the PAM service vsftpd will use.</td>
</tr>
<tr>
<td><code>rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem</code></td>
<td>The last three options specify the location of the RSA certificate to use for SSL encrypted connections.</td>
</tr>
<tr>
<td><code>rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key</code></td>
<td></td>
</tr>
<tr>
<td><code>ssl_enable=NO</code></td>
<td></td>
</tr>
</tbody>
</table>
<p>In addition, there is a file called <code>/etc/ftpusers</code> that we also need to pay attention to, as this file is used to deny certain users access to the FTP service. In the following example, the users <code>guest</code>, <code>john</code>, and <code>kevin</code> are not permitted to log in to the FTP service, even if they exist on the Linux system.</p>
<h4>FTPUSERS</h4>
<pre><code class="language-shell-session">[!bash!]$ cat /etc/ftpusers

guest
john
kevin
</code></pre>
<hr/>
<h2>Dangerous Settings</h2>
<p>There are many different security-related settings we can make on each FTP server. These can have various purposes, such as testing connections through the firewalls, testing routes, and authentication mechanisms. One of these authentication mechanisms is the <code>anonymous</code> user. This is often used to allow everyone on the internal network to share files and data without accessing each other's computers. With vsFTPd, the <a href="http://vsftpd.beasts.org/vsftpd_conf.html">optional settings</a> that can be added to the configuration file for the anonymous login look like this:</p>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>anonymous_enable=YES</code></td>
<td>Allowing anonymous login?</td>
</tr>
<tr>
<td><code>anon_upload_enable=YES</code></td>
<td>Allowing anonymous to upload files?</td>
</tr>
<tr>
<td><code>anon_mkdir_write_enable=YES</code></td>
<td>Allowing anonymous to create new directories?</td>
</tr>
<tr>
<td><code>no_anon_password=YES</code></td>
<td>Do not ask anonymous for password?</td>
</tr>
<tr>
<td><code>anon_root=/home/username/ftp</code></td>
<td>Directory for anonymous.</td>
</tr>
<tr>
<td><code>write_enable=YES</code></td>
<td>Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO,  MKD, RMD, APPE, and SITE?</td>
</tr>
</tbody>
</table>
<p>With the standard FTP client (<code>ftp</code>), we can access the FTP server accordingly and log in with the anonymous user if the settings shown above have been used. The use of the anonymous account can occur in internal environments and infrastructures where the participants are all known. Access to this type of service can be set temporarily or with the setting to accelerate the exchange of files.</p>
<p>As soon as we connect to the vsFTPd server, the <code>response code 220</code> is displayed with the banner of the FTP server. Often this banner contains the description of the <code>service</code> and even the <code>version</code> of it. It also tells us what type of system the FTP server is. One of the most common configurations of FTP servers is to allow <code>anonymous</code> access, which does not require legitimate credentials but provides access to some files. Even if we cannot download them, sometimes just listing the contents is enough to generate further ideas and note down information that will help us in another approach.</p>
<h4>Anonymous Login</h4>
<pre><code class="language-shell-session">[!bash!]$ ftp 10.129.14.136

Connected to 10.129.14.136.
220 "Welcome to the HTB Academy vsFTP service."
Name (10.129.14.136:cry0l1t3): anonymous

230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.


ftp&gt; ls

200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Clients
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt
226 Directory send OK.

</code></pre>
<p>However, to get the first overview of the server's settings, we can use the following command:</p>
<h4>vsFTPd Status</h4>
<pre><code class="language-shell-session">ftp&gt; status

Connected to 10.129.14.136.
No proxy connection.
Connecting using address family: any.
Mode: stream; Type: binary; Form: non-print; Structure: file
Verbose: on; Bell: off; Prompting: on; Globbing: on
Store unique: off; Receive unique: off
Case: off; CR stripping: on
Quote control characters: on
Ntrans: off
Nmap: off
Hash mark printing: off; Use of PORT cmds: on
Tick counter printing: off
</code></pre>
<p>Some commands should be used occasionally, as these will make the server show us more information that we can use for our purposes. These commands include <code>debug</code> and <code>trace</code>.</p>
<h4>vsFTPd Detailed Output</h4>
<pre><code class="language-shell-session">ftp&gt; debug

Debugging on (debug=1).


ftp&gt; trace

Packet tracing on.


ftp&gt; ls

---&gt; PORT 10,10,14,4,188,195
200 PORT command successful. Consider using PASV.
---&gt; LIST
150 Here comes the directory listing.
-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 1002     1002         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt
226 Directory send OK.
</code></pre>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dirmessage_enable=YES</code></td>
<td>Show a message when they first enter a new directory?</td>
</tr>
<tr>
<td><code>chown_uploads=YES</code></td>
<td>Change ownership of anonymously uploaded files?</td>
</tr>
<tr>
<td><code>chown_username=username</code></td>
<td>User who is given ownership of anonymously uploaded files.</td>
</tr>
<tr>
<td><code>local_enable=YES</code></td>
<td>Enable local users to login?</td>
</tr>
<tr>
<td><code>chroot_local_user=YES</code></td>
<td>Place local users into their home directory?</td>
</tr>
<tr>
<td><code>chroot_list_enable=YES</code></td>
<td>Use a list of local users that will be placed in their home directory?</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>Setting</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hide_ids=YES</code></td>
<td>All user and group information in directory listings will be displayed as "ftp".</td>
</tr>
<tr>
<td><code>ls_recurse_enable=YES</code></td>
<td>Allows the use of recurse listings.</td>
</tr>
</tbody>
</table>
<p>In the following example, we can see that if the <code>hide_ids=YES</code> setting is present, the UID and GUID representation of the service will be overwritten, making it more difficult for us to identify with which rights these files are written and uploaded.</p>
<h4>Hiding IDs - YES</h4>
<pre><code class="language-shell-session">ftp&gt; ls

---&gt; TYPE A
200 Switching to ASCII mode.
ftp: setsockopt (ignored): Permission denied
---&gt; PORT 10,10,14,4,223,101
200 PORT command successful. Consider using PASV.
---&gt; LIST
150 Here comes the directory listing.
-rw-rw-r--    1 ftp     ftp      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 ftp     ftp         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 ftp     ftp         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 ftp     ftp         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 ftp     ftp           41 Sep 14 16:45 Important Notes.txt
-rw-------    1 ftp     ftp            0 Sep 15 14:57 testupload.txt
226 Directory send OK.
</code></pre>
<p>This setting is a security feature to prevent local usernames from being revealed. With the usernames, we could attack the services like FTP and SSH and many others with a brute-force attack in theory. However, in reality, <a href="https://en.wikipedia.org/wiki/Fail2ban">fail2ban</a> solutions are now a standard implementation of any infrastructure that logs the IP address and blocks all access to the infrastructure after a certain number of failed login attempts.</p>
<p>Another helpful setting we can use for our purposes is the <code>ls_recurse_enable=YES</code>. This is often set on the vsFTPd server to have a better overview of the FTP directory structure, as it allows us to see all the visible content at once.</p>
<h4>Recursive Listing</h4>
<pre><code class="language-shell-session">ftp&gt; ls -R

---&gt; PORT 10,10,14,4,222,149
200 PORT command successful. Consider using PASV.
---&gt; LIST -R
150 Here comes the directory listing.
.:
-rw-rw-r--    1 ftp      ftp      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 ftp      ftp           41 Sep 14 16:45 Important Notes.txt
-rw-------    1 ftp      ftp            0 Sep 15 14:57 testupload.txt

./Clients:
drwx------    2 ftp      ftp          4096 Sep 16 18:04 HackTheBox
drwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:00 Inlanefreight

./Clients/HackTheBox:
-rw-r--r--    1 ftp      ftp         34872 Sep 16 18:04 appointments.xlsx
-rw-r--r--    1 ftp      ftp        498123 Sep 16 18:04 contract.docx
-rw-r--r--    1 ftp      ftp        478237 Sep 16 18:04 contract.pdf
-rw-r--r--    1 ftp      ftp           348 Sep 16 18:04 meetings.txt

./Clients/Inlanefreight:
-rw-r--r--    1 ftp      ftp         14211 Sep 16 18:00 appointments.xlsx
-rw-r--r--    1 ftp      ftp         37882 Sep 16 17:58 contract.docx
-rw-r--r--    1 ftp      ftp            89 Sep 16 17:58 meetings.txt
-rw-r--r--    1 ftp      ftp        483293 Sep 16 17:59 proposal.pptx

./Documents:
-rw-r--r--    1 ftp      ftp         23211 Sep 16 18:05 appointments-template.xlsx
-rw-r--r--    1 ftp      ftp         32521 Sep 16 18:05 contract-template.docx
-rw-r--r--    1 ftp      ftp        453312 Sep 16 18:05 contract-template.pdf

./Employees:
226 Directory send OK.

</code></pre>
<p><code>Downloading</code> files from such an FTP server is one of the main features, as well as <code>uploading</code> files created by us. This allows us, for example, to use LFI vulnerabilities to make the host execute system commands. Apart from the files, we can view, download and inspect. Attacks are also possible with the FTP logs, leading to <code>Remote Command Execution</code> (<code>RCE</code>). This applies to the FTP services and all those we can detect during our enumeration phase.</p>
<h4>Download a File</h4>
<pre><code class="language-shell-session">ftp&gt; ls

200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rwxrwxrwx    1 ftp      ftp             0 Sep 16 17:24 Calendar.pptx
drwxrwxrwx    4 ftp      ftp          4096 Sep 16 17:57 Clients
drwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:05 Documents
drwxrwxrwx    2 ftp      ftp          4096 Sep 16 17:24 Employees
-rwxrwxrwx    1 ftp      ftp            41 Sep 18 15:58 Important Notes.txt
226 Directory send OK.


ftp&gt; get Important\ Notes.txt

local: Important Notes.txt remote: Important Notes.txt
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for Important Notes.txt (41 bytes).
226 Transfer complete.
41 bytes received in 0.00 secs (606.6525 kB/s)


ftp&gt; exit

221 Goodbye.
</code></pre>
<pre><code class="language-shell-session">[!bash!]$ ls | grep Notes.txt

'Important Notes.txt'
</code></pre>
<p>We also can download all the files and folders we have access to at once. This is especially useful if the FTP server has many different files in a larger folder structure. However, this can cause alarms because no one from the company usually wants to download all files and content all at once.</p>
<h4>Download All Available Files</h4>
<pre><code class="language-shell-session">[!bash!]$ wget -m --no-passive ftp://anonymous:<a class="__cf_email__" data-cfemail="abcac5c4c5d2c6c4ded8eb9a9b859a9992859a9f859a989d" href="/cdn-cgi/l/email-protection">[email protected]</a>

--2021-09-19 14:45:58--  ftp://anonymous:*password*@10.129.14.136/                                         
           =&gt; ‘10.129.14.136/.listing’                                                                     
Connecting to 10.129.14.136:21... connected.                                                               
Logging in as anonymous ... Logged in!
==&gt; SYST ... done.    ==&gt; PWD ... done.
==&gt; TYPE I ... done.  ==&gt; CWD not needed.
==&gt; PORT ... done.    ==&gt; LIST ... done.                                                                 
12.12.1.136/.listing           [ &lt;=&gt;                                  ]     466  --.-KB/s    in 0s       
                                                                                                         
2021-09-19 14:45:58 (65,8 MB/s) - ‘10.129.14.136/.listing’ saved [466]                                     
--2021-09-19 14:45:58--  ftp://anonymous:*password*@10.129.14.136/Calendar.pptx   
           =&gt; ‘10.129.14.136/Calendar.pptx’                                       
==&gt; CWD not required.                                                           
==&gt; SIZE Calendar.pptx ... done.                                                                                                                            
==&gt; PORT ... done.    ==&gt; RETR Calendar.pptx ... done.       

...SNIP...

2021-09-19 14:45:58 (48,3 MB/s) - ‘10.129.14.136/Employees/.listing’ saved [119]

FINISHED --2021-09-19 14:45:58--
Total wall clock time: 0,03s
Downloaded: 15 files, 1,7K in 0,001s (3,02 MB/s)
</code></pre>
<p>Once we have downloaded all the files, <code>wget</code> will create a directory with the name of the IP address of our target. All downloaded files are stored there, which we can then inspect locally.</p>
<pre><code class="language-shell-session">[!bash!]$ tree .

.
└── 10.129.14.136
    ├── Calendar.pptx
    ├── Clients
    │   └── Inlanefreight
    │       ├── appointments.xlsx
    │       ├── contract.docx
    │       ├── meetings.txt
    │       └── proposal.pptx
    ├── Documents
    │   ├── appointments-template.xlsx
    │   ├── contract-template.docx
    │   └── contract-template.pdf
    ├── Employees
    └── Important Notes.txt

5 directories, 9 files
</code></pre>
<p>Next, we can check if we have the permissions to upload files to the FTP server. Especially with web servers, it is common that files are synchronized, and the developers have quick access to the files. FTP is often used for this purpose, and most of the time, configuration errors are found on servers that the administrators think are not discoverable. The attitude that internal network components cannot be accessed from the outside means that the hardening of internal systems is often neglected and leads to misconfigurations.</p>
<p>The ability to upload files to the FTP server connected to a web server increases the likelihood of gaining direct access to the webserver and even a reverse shell that allows us to execute internal system commands and perhaps even escalate our privileges.</p>
<h4>Upload a File</h4>
<pre><code class="language-shell-session">[!bash!]$ touch testupload.txt
</code></pre>
<p>With the <code>PUT</code> command, we can upload files in the current folder to the FTP server.</p>
<pre><code class="language-shell-session">ftp&gt; put testupload.txt 

local: testupload.txt remote: testupload.txt
---&gt; PORT 10,10,14,4,184,33
200 PORT command successful. Consider using PASV.
---&gt; STOR testupload.txt
150 Ok to send data.
226 Transfer complete.


ftp&gt; ls

---&gt; TYPE A
200 Switching to ASCII mode.
---&gt; PORT 10,10,14,4,223,101
200 PORT command successful. Consider using PASV.
---&gt; LIST
150 Here comes the directory listing.
-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 1002     1002         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt
-rw-------    1 1002     133             0 Sep 15 14:57 testupload.txt
226 Directory send OK.

</code></pre>
<hr/>
<h2>Footprinting the Service</h2>
<p>Footprinting using various network scanners is also a handy and widespread approach. These tools make it easier for us to identify different services, even if they are not accessible on standard ports. One of the most widely used tools for this purpose is Nmap. Nmap also brings the <a href="https://nmap.org/book/nse.html">Nmap Scripting Engine</a> (<code>NSE</code>), a set of many different scripts written for specific services. More information on the capabilities of Nmap and NSE can be found in the <a href="https://academy.hackthebox.com/course/preview/network-enumeration-with-nmap">Network Enumeration with Nmap</a> module. We can update this database of NSE scripts with the command shown.</p>
<h4>Nmap FTP Scripts</h4>
<pre><code class="language-shell-session">[!bash!]$ sudo nmap --script-updatedb

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 13:49 CEST
NSE: Updating rule database.
NSE: Script Database updated successfully.
Nmap done: 0 IP addresses (0 hosts up) scanned in 0.28 seconds
</code></pre>
<p>All the NSE scripts are located on the Pwnbox in <code>/usr/share/nmap/scripts/</code>, but on our systems, we can find them using a simple command on our system.</p>
<pre><code class="language-shell-session">[!bash!]$ find / -type f -name ftp* 2&gt;/dev/null | grep scripts

/usr/share/nmap/scripts/ftp-syst.nse
/usr/share/nmap/scripts/ftp-vsftpd-backdoor.nse
/usr/share/nmap/scripts/ftp-vuln-cve2010-4221.nse
/usr/share/nmap/scripts/ftp-proftpd-backdoor.nse
/usr/share/nmap/scripts/ftp-bounce.nse
/usr/share/nmap/scripts/ftp-libopie.nse
/usr/share/nmap/scripts/ftp-anon.nse
/usr/share/nmap/scripts/ftp-brute.nse
</code></pre>
<p>As we already know, the FTP server usually runs on the standard TCP port 21, which we can scan using Nmap. We also use the version scan (<code>-sV</code>), aggressive scan (<code>-A</code>), and the default script scan (<code>-sC</code>) against our target <code>10.129.14.136</code>.</p>
<h4>Nmap</h4>
<pre><code class="language-shell-session">[!bash!]$ sudo nmap -sV -p21 -sC -A 10.129.14.136

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-16 18:12 CEST
Nmap scan report for 10.129.14.136
Host is up (0.00013s latency).

PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 2.0.8 or later
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
| -rwxrwxrwx    1 ftp      ftp       8138592 Sep 16 17:24 Calendar.pptx [NSE: writeable]
| drwxrwxrwx    4 ftp      ftp          4096 Sep 16 17:57 Clients [NSE: writeable]
| drwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:05 Documents [NSE: writeable]
| drwxrwxrwx    2 ftp      ftp          4096 Sep 16 17:24 Employees [NSE: writeable]
| -rwxrwxrwx    1 ftp      ftp            41 Sep 16 17:24 Important Notes.txt [NSE: writeable]
|_-rwxrwxrwx    1 ftp      ftp             0 Sep 15 14:57 testupload.txt [NSE: writeable]
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to 10.10.14.4
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
</code></pre>
<p>The default script scan is based on the services' fingerprints, responses, and standard ports.  Once Nmap has detected the service, it executes the marked scripts one after the other, providing different information. For example, the <a href="https://nmap.org/nsedoc/scripts/ftp-anon.html">ftp-anon</a> NSE script checks whether the FTP server allows anonymous access. If so, the contents of the FTP root directory are rendered for the anonymous user.</p>
<p>The <code>ftp-syst</code>, for example, executes the <code>STAT</code> command, which displays information about the FTP server status. This includes configurations as well as the version of the FTP server. Nmap also provides the ability to trace the progress of NSE scripts at the network level if we use the <code>--script-trace</code> option in our scans. This lets us see what commands Nmap sends, what ports are used, and what responses we receive from the scanned server.</p>
<h4>Nmap Script Trace</h4>
<pre><code class="language-shell-session">[!bash!]$ sudo nmap -sV -p21 -sC -A 10.129.14.136 --script-trace

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 13:54 CEST                                                                                                                                                   
NSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 8 [10.129.14.136:21]                                   
NSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 16 [10.129.14.136:21]             
NSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 24 [10.129.14.136:21]
NSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 32 [10.129.14.136:21]
NSOCK INFO [11.4640s] nsock_read(): Read request from IOD #1 [10.129.14.136:21] (timeout: 7000ms) EID 42
NSOCK INFO [11.4640s] nsock_read(): Read request from IOD #2 [10.129.14.136:21] (timeout: 9000ms) EID 50
NSOCK INFO [11.4640s] nsock_read(): Read request from IOD #3 [10.129.14.136:21] (timeout: 7000ms) EID 58
NSOCK INFO [11.4640s] nsock_read(): Read request from IOD #4 [10.129.14.136:21] (timeout: 11000ms) EID 66
NSE: TCP 10.10.14.4:54226 &gt; 10.129.14.136:21 | CONNECT
NSE: TCP 10.10.14.4:54228 &gt; 10.129.14.136:21 | CONNECT
NSE: TCP 10.10.14.4:54230 &gt; 10.129.14.136:21 | CONNECT
NSE: TCP 10.10.14.4:54232 &gt; 10.129.14.136:21 | CONNECT
NSOCK INFO [11.4660s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID 50 [10.129.14.136:21] (41 bytes): 220 Welcome to HTB-Academy FTP service...
NSOCK INFO [11.4660s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID 58 [10.129.14.136:21] (41 bytes): 220 Welcome to HTB-Academy FTP service...
NSE: TCP 10.10.14.4:54228 &lt; 10.129.14.136:21 | 220 Welcome to HTB-Academy FTP service.
</code></pre>
<p>The scan history shows that four different parallel scans are running against the service, with various timeouts. For the NSE scripts, we see that our local machine uses other output ports (<code>54226</code>, <code>54228</code>, <code>54230</code>, <code>54232</code>) and first initiates the connection with the <code>CONNECT</code> command. From the first response from the server, we can see that we are receiving the banner from the server to our second NSE script (<code>54228</code>) from the target FTP server. If necessary, we can, of course, use other applications such as <code>netcat</code> or <code>telnet</code> to interact with the FTP server.</p>
<h4>Service Interaction</h4>
<pre><code class="language-shell-session">[!bash!]$ nc -nv 10.129.14.136 21
</code></pre>
<pre><code class="language-shell-session">[!bash!]$ telnet 10.129.14.136 21
</code></pre>
<p>It looks slightly different if the FTP server runs with TLS/SSL encryption. Because then we need a client that can handle TLS/SSL. For this, we can use the client <code>openssl</code> and communicate with the FTP server. The good thing about using <code>openssl</code> is that we can see the SSL certificate, which can also be helpful.</p>
<pre><code class="language-shell-session">[!bash!]$ openssl s_client -connect 10.129.14.136:21 -starttls ftp

CONNECTED(00000003)                                                                                      
Can't use SSL_get_servername                        
depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = <a class="__cf_email__" data-cfemail="a8c9ccc5c1c6e8c1c6c4c9c6cdcedacdc1cfc0dc86c0dcca" href="/cdn-cgi/l/email-protection">[email protected]</a>
verify error:num=18:self signed certificate
verify return:1

depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = <a class="__cf_email__" data-cfemail="5332373e3a3d133a3d3f323d363521363a343b277d3b2731" href="/cdn-cgi/l/email-protection">[email protected]</a>
verify return:1
---                                                 
Certificate chain
 0 s:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = <a class="__cf_email__" data-cfemail="58393c3531361831363439363d3e2a3d313f302c76302c3a" href="/cdn-cgi/l/email-protection">[email protected]</a>
 
 i:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = <a class="__cf_email__" data-cfemail="09686d6460674960676568676c6f7b6c606e617d27617d6b" href="/cdn-cgi/l/email-protection">[email protected]</a>
---
 
Server certificate

-----BEGIN CERTIFICATE-----

MIIENTCCAx2gAwIBAgIUD+SlFZAWzX5yLs2q3ZcfdsRQqMYwDQYJKoZIhvcNAQEL
...SNIP...
</code></pre>
<p>This is because the SSL certificate allows us to recognize the <code>hostname</code>, for example, and in most cases also an <code>email address</code> for the organization or company. In addition, if the company has several locations worldwide, certificates can also be created for specific locations, which can also be identified using the SSL certificate.</p>
<div class="my-3 p-3 vpn-switch-card" id="vpn-switch">
<p class="font-size-14 color-white mb-0">VPN Servers</p>
<p class="font-size-13 mb-0">
<i class="fas fa-exclamation-triangle text-warning"></i><span class="color-white ml-1">Warning:</span> Each
                    time you "Switch",
                    your connection keys are regenerated and you must re-download your VPN connection file.
                </p>
<p class="font-size-13 mb-0">
                    All VM instances associated with the old VPN Server will be terminated when switching to
                    a new VPN server. <br/>
                    Existing PwnBox instances will automatically switch to the new VPN server.</p>
<div class="row mb-3">
<div class="col-12 mt-2">
<div class="d-none justify-content-center vpn-loader">
<div class="spinner-border text-success" role="status">
<span class="sr-only">Switching VPN...</span>
</div>
</div>
<select aria-label="vpn server" class="selectpicker custom-form-control vpnSelector badge-select" title="Select VPN Server">
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 6 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt; &lt;span class='recommended'&gt; &lt;img src='/images/sparkles-solid.svg'/&gt;Recommended&lt;/span&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="30" value="17">US Academy 6</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 5 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="31" value="16">US Academy 5</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 4 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="32" value="13">US Academy 4</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 1 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="33" value="4">US Academy 1</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 2 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="33" value="5">US Academy 2</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 5 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt; &lt;span class='recommended'&gt; &lt;img src='/images/sparkles-solid.svg'/&gt;Recommended&lt;/span&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="37" value="12">EU Academy 5</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 3 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="38" value="9">US Academy 3</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 2 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="39" selected="" value="2">EU Academy 2</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 1 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="40" value="1">EU Academy 1</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 3 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="41" value="14">EU Academy 3</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 4 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="43" value="11">EU Academy 4</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 6 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="47" value="15">EU Academy 6</option>
</select>
<p class="font-size-14 color-white mb-0 mt-2">PROTOCOL</p>
<div class="d-flex">
<div class="custom-control custom-radio custom-control-inline">
<input checked="" class="custom-control-input" id="rd_1" name="vpn-protocol" type="radio" value="udp"/>
<label class="custom-control-label green font-size-14" for="rd_1">UDP
                                    1337</label>
</div>
<div class="custom-control custom-radio">
<input class="custom-control-input" id="rd_2" name="vpn-protocol" type="radio" value="tcp"/>
<label class="custom-control-label green font-size-14" for="rd_2">TCP
                                    443</label>
</div>
</div>
<div class="d-flex justify-content-center">
<button class="btn btn-outline-success btn-lg download-vpn-settings mt-3 px-5 font-size-12">
                                DOWNLOAD VPN CONNECTION FILE
                            </button>
</div>
</div>
</div>
</div>
<div class="mb-5 pwnbox-select-card"></div>
<div id="screen" style="height: 600px; border: 1px solid;">
<div class="screenPlaceholder">
<div class="instanceLoading" style="display: none;">
<h1 class="text-center" style="margin-top: 270px;"><i class="fa fa-circle-notch fa-spin"></i>
</h1>
<div class="text-center">Instance is starting...</div>
</div>
<div class="instanceTerminating" style="display: none;">
<h1 class="text-center" style="margin-top: 270px;"><i class="fa fa-circle-notch fa-spin"></i>
</h1>
<div class="text-center">Terminating instance...</div>
</div>
<div class="row instanceStart max-width-canvas">
<div class="col-4"></div>
<div class="col-4">
<button class="startInstanceBtn btn btn-success text-light btn-lg btn-block" style="margin-top: 270px;">Start Instance
                            </button>
<p class="text-center mt-2 font-size-13 font-secondary">
<span class="text-success spawnsLeft">
<i class="fal fa-infinity"></i>
</span> / 1 spawns left
                            </p>
</div>
<div class="col-4"></div>
</div>
</div>
</div>
<div class="row align-center justify-center my-4">
<div class="col-5 justify-start">
<button class="instance-button fullScreenBtn btn btn-light btn-sm float-left" style="display:none;" target="_blank"><i class="fad fa-expand text-success mr-1"></i>  Full Screen
                    </button>
<button class="instance-button terminateInstanceBtn btn btn-light btn-sm ml-2" style="display:none;"><i class="fad fa-times text-danger"></i>  Terminate
                    </button>
<button class="instance-button resetInstanceBtn btn btn-light btn-sm ml-1" style="display:none;"><i class="fad fa-sync text-warning mr-2"></i>  Reset
                    </button>
<div class="btn-group" role="group">
<button class="instance-button extendInstanceBtn btn btn-light btn-sm ml-1" style="display:none;cursor: default;">Life Left:
                            <span class="lifeLeft"></span>m
                        </button>
<button class="extendInstanceBtn extendInstanceBtnClicker btn btn-light btn-sm" data-title="Extend Life" data-toggle="tooltip" style="display:none;"><i class="fa fa-plus text-success"></i></button>
</div>
</div>
<div class="col-7 justify-end pt-2 pr-2 font-size-small text-right" id="statusText">Waiting to
                    start...
                </div>
</div>
<div class="d-inline-block mb-2 solutionSettings solutionSettingsOffsets" id="solutionsModuleSetting">
<div class="border border-secondary p-2 rounded">
<div class="custom-control custom-switch d-flex">
<input class="custom-control-input" disabled="" id="showSolutionsModuleSetting" type="checkbox"/>
<label class="custom-control-label font-size-14 font-weight-normal text-white" for="showSolutionsModuleSetting">
                                Enable step-by-step solutions for all questions
                            </label>
<span aria-hidden="true" class="cursor-pointer font-size-14 ml-1 mr-1 text-white" data-content="Access to this feature is exclusive to annual subscribers. To acquire an annual subscription, kindly proceed by clicking &lt;a href='/billing'&gt;here&lt;/a&gt;." data-html="true" data-placement="top" data-toggle="popover" data-trigger="click" title="Activate Solutions">
<i class="fa fa-info-circle font-size-12"></i>
</span>
<img alt="sparkles-icon-decoration" class="ml-2 w-auto sparkles-icon" height="20" src="/images/sparkles-solid.svg">
</img></div>
</div>
</div>
<div class="card" id="questionsDiv">
<div class="card-body">
<div class="row">
<div class="col-9">
<h4 class="card-title mt-0 font-size-medium">Questions</h4>
<p class="card-title-desc font-size-large font-size-15">Answer the question(s) below
                                to complete this Section and earn cubes!</p>
<span class="spawnTargetBtn spawn-target-text-clone d-none">Click here to spawn the target
                                system!</span>
<p class="card-title-desc font-size-large font-size-15 mb-0">
    Target(s): <span class="text-success">
<span class="target" style="cursor:pointer;">
<i class="fad fa-circle-notch fa-spin"></i>
<span class="spawnTargetBtn">Fetching status...</span>
</span>
</span>
<button class="resetTargetBtn btn btn-light btn-sm" data-title="Reset Target(s)" data-toggle="tooltip" style="cursor: pointer; display: none;">
<i class="fad fa-sync text-warning"></i>
</button>
<br/>
<div class="d-flex align-items-center targetLifeContainer">
<span class="targetLifeTimeContainer" style="display: none;">
            Life Left: <span class="targetLifeTime font-size-15">0</span> minute(s)
                            <button class="extendTargetSystemBtn btn btn-light btn-sm module-button" data-title="Extend Life by 1 hour (up to 6 hours total lifespan)" data-toggle="tooltip">
<i class="fa fa-plus text-success extend-icon"></i>
<div class="extend-loader spinner-border spinner-border-small text-success d-none" role="status">
</div>
</button>
<button class="text-danger btn btn-light btn-sm module-button font-size-16 mb-1" data-target="#terminateVmModal" data-toggle="modal">
                    Terminate <span class="fa-regular fa-x text-danger font-size-13 ml-2"></span>
</button>
</span>
</div>
</p>
</div>
<div class="col-3 text-right float-right">
<button class="btn btn-light bg-color-blue-nav mt-2 w-100 d-flex align-items-center" data-target="#cheatSheetModal" data-toggle="modal">
<div><i class="fad fa-file-alt mr-2"></i></div>
<div class="text-center w-100 ml-1">Cheat Sheet</div>
</button>
<a class="btn btn-light bg-color-blue-nav mt-2 d-flex align-items-center" data-title='Key is already installed in "My Workstation"' data-toggle="tooltip" href="https://academy.hackthebox.com/vpn/key">
<div><i class="fad fa-chart-network mr-2"></i></div>
<div class="text-center w-100">Download VPN Connection File</div>
</a>
</div>
</div>
<div>
<div>
<label class="module-question" for="909"><span class="badge badge-soft-dark font-size-14 mr-2">+ 0 <i class="fad fa-cube text-success"></i></span> Which version of the FTP server is running on the target system? Submit the entire banner as the answer.
                            </label>
<div class="row">
<div class="col-lg-12 mb-4">
<input class="form-control bg-color-blue-nav" color="green" id="answer909" maxlength="191" placeholder="Submit your answer here..." type="text"/>
</div>
<div class="d-flex justify-content-end w-100 mr-3">
<p class="mb-0 mr-3 mt-1 font-size-14 font-medium text-white" id="questionStreakPointsText-909">
                                        +10 Streak pts</p>
<div class="mb-4 mr-1 d-flex align-items-center">
<button class="btn btn-primary btn-block btnAnswer" data-question-id="909" id="btnAnswer909">
<div class="submit-button-text">
<i class="fad fa-flag-checkered mr-2"></i> Submit
                                            </div>
<div class="submit-button-loader mx-4 d-none">
<i class="fa fa-circle-notch fa-spin"></i>
</div>
</button>
</div>
</div>
</div>
<div class="custom-hr">
</div>
</div>
<div>
<label class="module-question" for="910"><span class="badge badge-soft-dark font-size-14 mr-2">+ 0 <i class="fad fa-cube text-success"></i></span> Enumerate the FTP server and find the flag.txt file. Submit the contents of it as the answer.
                            </label>
<div class="row">
<div class="col-lg-12 mb-4">
<input class="form-control bg-color-blue-nav" color="green" id="answer910" maxlength="191" placeholder="Submit your answer here..." type="text"/>
</div>
<div class="d-flex justify-content-end w-100 mr-3">
<p class="mb-0 mr-3 mt-1 font-size-14 font-medium text-white" id="questionStreakPointsText-910">
                                        +10 Streak pts</p>
<div class="mb-4 mr-1 d-flex align-items-center">
<button class="btn btn-primary btn-block btnAnswer" data-question-id="910" id="btnAnswer910">
<div class="submit-button-text">
<i class="fad fa-flag-checkered mr-2"></i> Submit
                                            </div>
<div class="submit-button-loader mx-4 d-none">
<i class="fa fa-circle-notch fa-spin"></i>
</div>
</button>
</div>
</div>
</div>
<div class="">
</div>
</div>
</div>
</div>
</div>
