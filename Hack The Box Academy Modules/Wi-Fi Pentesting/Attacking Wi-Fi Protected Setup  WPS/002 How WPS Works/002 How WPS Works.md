
<h1>How WPS Works</h1>
<hr/>
<p>WPS works by establishing authentication through a series of <a href="https://en.wikipedia.org/wiki/Extensible_Authentication_Protocol">Extensible Authentication Protocol (EAP)</a> messages. Some of the information communicated includes Public Keys, PINs, and nonce values. Essentially, after some checks and balances between the access point and the connected client, the access point (registrar) shares the WPA pre-shared key, which allows the connected client (enrollee) to ensure communications as normal with WPA. It should also be noted that when WPS (Wi-Fi Protected Setup) is used to configure an access point, the roles of the access point (AP) and the client device can switch. In this case, the AP may act as the Enrollee, while the client device assumes the role of the Registrar, which is responsible for <a href="https://android.googlesource.com/platform/external/wpa_supplicant_8/+/master/wpa_supplicant/README-WPS#36">configuring the AP</a>.</p>
<p>There are several methods for WPS to begin the series of EAP messages. Commonly these are through the PIN method initiated by the client, and the push button method initiated manually on the access point. There are other methods as well such as the Near-field communication method through the usage of RFID among many other WPS-related technologies.</p>
<hr/>
<h3>WPS PIN Anatomy</h3>
<p>The WPS PIN is eight digits in length and consists of two primary portions. The first portion is used in the M4 and M5 EAP messages, and the second portion is used in the M6 and M7 EAP messages. Each of these portions is four digits in length. Most would assume that there would be 100,000,000 (10<sup>8</sup>) possible digit combinations, but in the case of WPS, this is not true. There are only 11,000 possible combinations.</p>
<p><img alt="image" src="https://academy.hackthebox.com/storage/modules/186/WPSAlgorithm/PIN/WPS_PIN.png"/></p>
<p>This is due to how the PIN functions. The first half only has 10<sup>4</sup> possible combinations and the second half has only 10<sup>3</sup> possible combinations. The last digit of the second half is used as a checksum and can be easily calculated. Therefore, there are only 10,000 (10<sup>4</sup>) + 1,000(10<sup>3</sup>) possible digit combinations, which is 11,000 total combinations.</p>
<hr/>
<h3>WPS EAP Messages</h3>
<p>Before describing the series of EAP messages, the following definitions will come in handy.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PKe</code></td>
<td>This is the Enrollee's (Access Point's) Diffie-Hellman public key.</td>
</tr>
<tr>
<td><code>PKr</code></td>
<td>This is the Registrar's (Station's/Client's) Diffie-Hellman public key.</td>
</tr>
<tr>
<td><code>PSK1</code></td>
<td>First four-digit portion of the PIN (10,000 possible combinations).</td>
</tr>
<tr>
<td><code>PSK2</code></td>
<td>Second four-digit portion of the PIN (1,000 possible combinations). The last digit is used as the checksum.</td>
</tr>
<tr>
<td><code>KDK (Key Derivation Key)</code></td>
<td>This is a key used in derivation for the auth key.</td>
</tr>
<tr>
<td><code>KWK (Key Wrap Key)</code></td>
<td>Used in the process of encrypting messages with AES.</td>
</tr>
<tr>
<td><code>E-S1</code></td>
<td>This is a secret 128-bit enrollee (AP) nonce value used in derivation for E-Hash1.</td>
</tr>
<tr>
<td><code>E-S2</code></td>
<td>This is a secret 128-bit enrollee (AP) nonce value used in derivation for E-Hash2.</td>
</tr>
<tr>
<td><code>R-S1</code></td>
<td>This is a secret 128-bit registrar (client/station) nonce value used in derivation for R-Hash1.</td>
</tr>
<tr>
<td><code>R-S2</code></td>
<td>This is a secret 128-bit registrar (client/station) nonce value used in derivation for R-Hash2.</td>
</tr>
<tr>
<td><code>E-Hash1 (Enrollee Hash1)</code></td>
<td>Comprised of the E-S1 nonce value, PSK1, PKe, and PKr values. Created through the HMAC-SHA-256 hashing function using the Auth Key.</td>
</tr>
<tr>
<td><code>E-Hash2 (Enrollee Hash2)</code></td>
<td>Comprised of the E-S2 nonce value, PSK2, PKe, and PKr values. Created through the HMAC-SHA-256 hashing function using the Auth Key.</td>
</tr>
<tr>
<td><code>R-Hash1 (Registrar Hash1)</code></td>
<td>Comprised of the R-S1 nonce value, PSK1, PKe, and PKr values. Created through the HMAC-SHA-256 hashing function using the Auth Key.</td>
</tr>
<tr>
<td><code>R-Hash2 (Registrar Hash2)</code></td>
<td>Comprised of the R-S2 nonce value, PSK2, PKe, and PKr values. Created through the HMAC-SHA-256 hashing function using the Auth Key.</td>
</tr>
<tr>
<td><code>Auth Key</code></td>
<td>Derived from the KDK, PSK1, and PSK2 values.</td>
</tr>
<tr>
<td><code>WPA-PSK</code></td>
<td>This is the final disclosed pre-shared key (aka password) used to authenticate the client.</td>
</tr>
</tbody>
</table>
<p>The series of EAP messages from a high level looks like the following:</p>
<p><img alt="image" src="https://academy.hackthebox.com/storage/modules/186/WPSAlgorithm/EAPSeries/WPS_EAP.png"/></p>
<p>Each of these messages is responsible for disclosing different information, and they conduct the following.</p>
<table>
<thead>
<tr>
<th>Message</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>EAPOL-Start</code></td>
<td>The connected client initiates the series of EAP messages.</td>
</tr>
<tr>
<td><code>EAP Request Identity</code></td>
<td>The access point requests the connected client's identity.</td>
</tr>
<tr>
<td><code>EAP Response Identity</code></td>
<td>The client sends the access point its identity as requested.</td>
</tr>
<tr>
<td><code>EAP M1 Message</code></td>
<td>The access point sends the client their Diffie-Hellman public key (PKe).</td>
</tr>
<tr>
<td><code>EAP M2 Message</code></td>
<td>The client then sends the Access point the their Diffie-Hellman public key (PKr).</td>
</tr>
<tr>
<td><code>EAP M3 Message</code></td>
<td>The access point sends the client the E-Hash1 and E-Hash2 values.</td>
</tr>
<tr>
<td><code>EAP M4 Message</code></td>
<td>The client then sends the access point the R-Hash1, R-Hash2, and R-S1 nonce value encrypted with AES.</td>
</tr>
<tr>
<td><code>EAP M5 Message</code></td>
<td>The access point sends the client the E-S1 nonce value encrypted with AES.</td>
</tr>
<tr>
<td><code>EAP M6 Message</code></td>
<td>The client sends the access point the R-S2 nonce value encrypted with AES.</td>
</tr>
<tr>
<td><code>EAP M7 Message</code></td>
<td>If the PIN is correct, the access point sends the client the E-S2 value and the WPA-PSK encrypted with AES.</td>
</tr>
<tr>
<td><code>EAP M8 Message</code></td>
<td>The client then sends the WPA-PSK back to the access point to begin the WPA handshake process.</td>
</tr>
</tbody>
</table>
<p>These EAP messages are simple yet somewhat complex. Fortunately for us, two different cracking methods can be employed to guess the correct PIN (through all 11,000 possible combinations) and retrieve the final WPA-PSK. These methods are online brute-forcing and offline brute-forcing, also known as the Pixie Dust Attack. In the following sections, we will be focusing on reconnaissance, both cracking methods, and additional PIN generation algorithms.</p>
